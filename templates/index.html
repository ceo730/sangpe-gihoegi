<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìƒí˜ê¸°íšê¸° â€” ì „í™˜ìœ¨ ì¤‘ì‹¬ ìƒì„¸í˜ì´ì§€ ë¶„ì„</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #232733;
    --border: #2e3345;
    --text: #e4e6ef;
    --text-dim: #8b8fa3;
    --accent: #6c63ff;
    --accent-glow: rgba(108,99,255,.25);
    --red: #ff6b6b;
    --orange: #ffa94d;
    --green: #51cf66;
    --blue: #339af0;
    --purple: #845ef7;
    --teal: #20c997;
    --pink: #f06595;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    border-bottom: 1px solid var(--border);
    padding: 1.25rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    backdrop-filter: blur(10px);
    position: sticky; top: 0; z-index: 100;
    background: rgba(15,17,23,.85);
  }
  .header h1 { font-size: 1.25rem; font-weight: 700; }
  .header h1 span { color: var(--accent); }
  .header .badge {
    font-size: .7rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: .2rem .7rem;
    color: var(--text-dim);
  }

  /* â”€â”€ Layout â”€â”€ */
  .container { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem; }

  /* â”€â”€ Upload Area â”€â”€ */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 16px;
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all .2s;
    background: var(--surface);
    position: relative;
  }
  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--accent);
    background: rgba(108,99,255,.05);
    box-shadow: 0 0 30px var(--accent-glow);
  }
  .upload-zone input { display: none; }
  .upload-zone .icon { font-size: 2.5rem; margin-bottom: .75rem; }
  .upload-zone p { color: var(--text-dim); font-size: .9rem; }
  .upload-zone .hint { font-size: .8rem; color: var(--text-dim); margin-top: .5rem; opacity: .7; }

  /* â”€â”€ Preview â”€â”€ */
  .preview-grid {
    display: flex;
    gap: .75rem;
    flex-wrap: wrap;
    margin-top: 1.25rem;
  }
  .preview-item {
    position: relative;
    width: 120px; height: 120px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid var(--border);
  }
  .preview-item img { width: 100%; height: 100%; object-fit: cover; }
  .preview-item .remove {
    position: absolute; top: 4px; right: 4px;
    background: rgba(0,0,0,.7); color: #fff;
    border: none; border-radius: 50%;
    width: 22px; height: 22px; cursor: pointer;
    font-size: .75rem; display: flex; align-items: center; justify-content: center;
  }

  /* â”€â”€ Button â”€â”€ */
  .btn-analyze {
    padding: .75rem 2rem;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
    margin-top: 1.5rem;
    width: 100%;
  }
  .btn-analyze:hover { box-shadow: 0 4px 20px var(--accent-glow); transform: translateY(-1px); }
  .btn-analyze:disabled { opacity: .4; cursor: not-allowed; transform: none; box-shadow: none; }

  /* â”€â”€ Multi-step Loading â”€â”€ */
  .loading-wrap {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    padding: 3rem 0;
  }
  .loading-wrap.show { display: flex; }
  .spinner {
    width: 48px; height: 48px;
    border: 4px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-steps {
    display: flex;
    gap: .5rem;
    flex-wrap: wrap;
    justify-content: center;
  }
  .loading-step {
    display: flex;
    align-items: center;
    gap: .4rem;
    padding: .4rem .8rem;
    border-radius: 8px;
    font-size: .8rem;
    color: var(--text-dim);
    background: var(--surface);
    border: 1px solid var(--border);
    transition: all .3s;
  }
  .loading-step.active {
    color: var(--accent);
    border-color: var(--accent);
    background: rgba(108,99,255,.08);
  }
  .loading-step.done {
    color: var(--green);
    border-color: var(--green);
    background: rgba(81,207,102,.08);
  }
  .loading-step .step-icon { font-size: .9rem; }
  .loading-msg { color: var(--text-dim); font-size: .9rem; }

  /* â”€â”€ Error â”€â”€ */
  .error-box {
    background: rgba(255,107,107,.1);
    border: 1px solid var(--red);
    border-radius: 10px;
    padding: 1rem 1.25rem;
    color: var(--red);
    margin-top: 1.5rem;
    display: none;
  }
  .error-box.show { display: block; }

  /* â”€â”€ Results â”€â”€ */
  #results { display: none; margin-top: 2.5rem; }
  #results.show { display: block; }

  .section-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 2rem 0 1rem;
    display: flex;
    align-items: center;
    gap: .5rem;
  }
  .section-title::before {
    content: '';
    width: 4px; height: 1.1rem;
    background: var(--accent);
    border-radius: 2px;
  }

  /* â”€â”€ Score Dashboard â”€â”€ */
  .score-dashboard {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .score-gauge {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: .5rem;
  }
  .score-gauge svg { width: 140px; height: 140px; }
  .score-gauge .grade-label {
    font-size: 1rem;
    font-weight: 700;
    padding: .2rem .8rem;
    border-radius: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
  }
  .score-bars {
    display: flex;
    flex-direction: column;
    gap: .6rem;
    justify-content: center;
  }
  .score-bar-item {
    display: flex;
    align-items: center;
    gap: .75rem;
  }
  .score-bar-label {
    width: 60px;
    font-size: .8rem;
    color: var(--text-dim);
    text-align: right;
    flex-shrink: 0;
  }
  .score-bar-track {
    flex: 1;
    height: 10px;
    background: var(--surface2);
    border-radius: 5px;
    overflow: hidden;
    position: relative;
  }
  .score-bar-fill {
    height: 100%;
    border-radius: 5px;
    width: 0;
    transition: width 1s ease-out;
  }
  .score-bar-value {
    width: 36px;
    font-size: .8rem;
    font-weight: 700;
    text-align: left;
    flex-shrink: 0;
  }

  @media (max-width: 600px) {
    .score-dashboard { grid-template-columns: 1fr; }
    .score-gauge { margin-bottom: .5rem; }
  }

  /* â”€â”€ Metric Cards â”€â”€ */
  .metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: .75rem;
  }
  .metric-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
  }
  .metric-card .label { font-size: .75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: .05em; margin-bottom: .35rem; }
  .metric-card .value { font-size: 1.05rem; font-weight: 600; }

  /* â”€â”€ Framework Analysis â”€â”€ */
  .framework-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: .75rem;
  }
  @media (max-width: 768px) { .framework-grid { grid-template-columns: 1fr; } }
  .framework-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
  }
  .framework-card h4 {
    font-size: .95rem;
    font-weight: 700;
    margin-bottom: .75rem;
    display: flex;
    align-items: center;
    gap: .4rem;
  }
  .framework-item {
    display: flex;
    gap: .5rem;
    padding: .35rem 0;
    font-size: .85rem;
    color: var(--text-dim);
    border-bottom: 1px solid rgba(46,51,69,.5);
  }
  .framework-item:last-child { border-bottom: none; }
  .framework-item .fw-stage {
    width: 70px;
    font-weight: 600;
    color: var(--text);
    flex-shrink: 0;
    font-size: .8rem;
  }

  /* â”€â”€ Section Cards â”€â”€ */
  .section-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
    margin-bottom: .75rem;
    position: relative;
    overflow: hidden;
  }
  .section-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px;
  }
  .section-card .card-head {
    display: flex;
    align-items: center;
    gap: .6rem;
    margin-bottom: .75rem;
    flex-wrap: wrap;
  }
  .section-card .order-badge {
    width: 28px; height: 28px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: .8rem; font-weight: 700;
    color: #fff;
    flex-shrink: 0;
  }
  .section-card .role-name { font-weight: 700; font-size: 1rem; }
  .section-card .stage-tag {
    font-size: .65rem;
    padding: .15rem .5rem;
    border-radius: 4px;
    font-weight: 600;
    background: rgba(108,99,255,.12);
    color: var(--accent);
  }
  .section-card .score-badge {
    margin-left: auto;
    font-size: .75rem;
    font-weight: 700;
    padding: .15rem .5rem;
    border-radius: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
  }
  .section-card .detail { margin-top: .4rem; font-size: .88rem; color: var(--text-dim); }
  .section-card .detail strong { color: var(--text); font-weight: 600; }
  .section-card .improvement-tip {
    margin-top: .6rem;
    padding: .5rem .75rem;
    background: rgba(108,99,255,.06);
    border-left: 3px solid var(--accent);
    border-radius: 0 6px 6px 0;
    font-size: .82rem;
    color: var(--accent);
  }

  /* â”€â”€ Structure Summary â”€â”€ */
  .summary-box {
    background: linear-gradient(135deg, rgba(108,99,255,.1), rgba(51,154,240,.1));
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
    font-size: .95rem;
    line-height: 1.7;
  }

  /* â”€â”€ Structured Strengths / Weaknesses â”€â”€ */
  .sw-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
  @media (max-width: 700px) { .sw-grid { grid-template-columns: 1fr; } }
  .sw-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
  }
  .sw-box h4 { margin-bottom: .75rem; font-size: .95rem; }
  .sw-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: .75rem;
    margin-bottom: .5rem;
    cursor: pointer;
    transition: all .2s;
  }
  .sw-item:hover { border-color: rgba(108,99,255,.3); }
  .sw-item .sw-title {
    font-size: .88rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: .4rem;
  }
  .sw-item .sw-detail {
    font-size: .82rem;
    color: var(--text-dim);
    margin-top: .35rem;
    display: none;
  }
  .sw-item.open .sw-detail { display: block; }
  .sw-item .sw-impact {
    font-size: .78rem;
    color: var(--orange);
    margin-top: .25rem;
    display: none;
  }
  .sw-item.open .sw-impact { display: block; }
  .sw-item .sw-toggle {
    margin-left: auto;
    font-size: .7rem;
    color: var(--text-dim);
    transition: transform .2s;
  }
  .sw-item.open .sw-toggle { transform: rotate(180deg); }

  /* â”€â”€ Priority Improvements â”€â”€ */
  .improve-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: .6rem;
    border-left: 4px solid var(--border);
  }
  .improve-card.priority-high { border-left-color: var(--red); }
  .improve-card.priority-mid { border-left-color: var(--orange); }
  .improve-card.priority-low { border-left-color: var(--blue); }
  .improve-head {
    display: flex;
    align-items: center;
    gap: .5rem;
    margin-bottom: .5rem;
    flex-wrap: wrap;
  }
  .priority-badge {
    font-size: .65rem;
    padding: .15rem .5rem;
    border-radius: 4px;
    font-weight: 700;
    color: #fff;
  }
  .priority-badge.high { background: var(--red); }
  .priority-badge.mid { background: var(--orange); }
  .priority-badge.low { background: var(--blue); }
  .category-badge {
    font-size: .65rem;
    padding: .15rem .5rem;
    border-radius: 4px;
    font-weight: 600;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
  }
  .improve-title { font-weight: 700; font-size: .95rem; }
  .improve-body { font-size: .85rem; color: var(--text-dim); margin-top: .25rem; }
  .improve-body .label { color: var(--text); font-weight: 600; }
  .improve-effect {
    margin-top: .4rem;
    padding: .35rem .6rem;
    background: rgba(81,207,102,.08);
    border-radius: 6px;
    font-size: .8rem;
    color: var(--green);
  }

  /* â”€â”€ Recommended Structure Timeline â”€â”€ */
  .timeline {
    position: relative;
    padding-left: 30px;
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 12px; top: 0; bottom: 0;
    width: 2px;
    background: var(--border);
  }
  .timeline-item {
    position: relative;
    padding: .75rem 0 .75rem 20px;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -22px; top: 1.1rem;
    width: 10px; height: 10px;
    border-radius: 50%;
    border: 2px solid var(--accent);
    background: var(--bg);
  }
  .timeline-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem 1.25rem;
  }
  .timeline-card .tl-head {
    display: flex;
    align-items: center;
    gap: .5rem;
    margin-bottom: .4rem;
    flex-wrap: wrap;
  }
  .timeline-card .tl-order {
    font-size: .75rem;
    font-weight: 700;
    color: var(--accent);
  }
  .timeline-card .tl-name {
    font-weight: 700;
    font-size: .95rem;
  }
  .timeline-card .tl-role-tag {
    font-size: .65rem;
    padding: .1rem .4rem;
    border-radius: 4px;
    font-weight: 600;
    color: #fff;
  }
  .timeline-card .tl-body {
    font-size: .82rem;
    color: var(--text-dim);
    margin-top: .25rem;
  }
  .timeline-card .tl-copy {
    font-style: italic;
    color: var(--text);
    margin-top: .3rem;
    font-size: .85rem;
    padding: .3rem .5rem;
    background: rgba(108,99,255,.05);
    border-radius: 4px;
  }

  /* â”€â”€ Draft Section â”€â”€ */
  .draft-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.5rem;
    margin-top: 1rem;
  }
  .btn-draft {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .65rem 1.5rem;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: .9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
  }
  .btn-draft:hover { box-shadow: 0 4px 20px var(--accent-glow); transform: translateY(-1px); }
  .btn-draft:disabled { opacity: .4; cursor: not-allowed; transform: none; }
  .draft-preview {
    margin-top: 1rem;
    display: none;
    text-align: center;
  }
  .draft-preview.show { display: block; }
  .draft-preview svg,
  .draft-preview img {
    max-width: 375px;
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #fff;
  }
  .draft-actions {
    display: flex;
    gap: .5rem;
    margin-top: .75rem;
    justify-content: center;
    flex-wrap: wrap;
  }
  .btn-download-svg {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    padding: .5rem 1.2rem;
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: .85rem;
    cursor: pointer;
    text-decoration: none;
    transition: all .2s;
  }
  .btn-download-svg:hover { border-color: var(--accent); background: rgba(108,99,255,.1); }
  .draft-guide {
    margin-top: .75rem;
    padding: .6rem .8rem;
    background: rgba(108,99,255,.06);
    border-radius: 8px;
    font-size: .78rem;
    color: var(--text-dim);
    line-height: 1.5;
  }

  /* â”€â”€ Figma Export â”€â”€ */
  .figma-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.5rem;
    margin-top: 1rem;
  }
  .btn-figma {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .65rem 1.5rem;
    background: #1e1e1e;
    color: #fff;
    border: 1px solid #333;
    border-radius: 10px;
    font-size: .9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
  }
  .btn-figma:hover { box-shadow: 0 4px 20px rgba(162,89,255,.25); border-color: #a259ff; }
  .btn-figma:disabled { opacity: .4; cursor: not-allowed; box-shadow: none; border-color: #333; }
  .figma-progress {
    margin-top: 1rem;
    display: none;
  }
  .figma-progress.show { display: block; }
  .figma-progress-bar {
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: .5rem;
  }
  .figma-progress-fill {
    height: 100%;
    background: #a259ff;
    border-radius: 3px;
    width: 0%;
    transition: width .3s;
  }
  .figma-progress-text {
    font-size: .8rem;
    color: var(--text-dim);
  }
  .figma-results {
    margin-top: 1rem;
    display: none;
  }
  .figma-results.show { display: block; }
  .figma-result-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: .75rem 1rem;
    margin-bottom: .5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .figma-result-item.error { border-color: var(--red); }
  .figma-result-label { font-size: .85rem; }
  .btn-figma-download {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    padding: .4rem 1rem;
    background: #a259ff;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: .8rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all .2s;
  }
  .btn-figma-download:hover { opacity: .85; }
  .figma-guide {
    margin-top: .75rem;
    padding: .75rem 1rem;
    background: rgba(162,89,255,.06);
    border-radius: 8px;
    font-size: .78rem;
    color: var(--text-dim);
    line-height: 1.6;
  }
  .figma-guide strong { color: var(--text); }
  .figma-guide ol { margin: .4rem 0 0 1.2rem; }

  /* â”€â”€ Download â”€â”€ */
  .btn-download {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .65rem 1.5rem;
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: .9rem;
    cursor: pointer;
    transition: all .2s;
    text-decoration: none;
    margin-top: 1rem;
  }
  .btn-download:hover { border-color: var(--accent); background: rgba(108,99,255,.1); }

  /* â”€â”€ Animations â”€â”€ */
  @keyframes fadeSlideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .anim-card {
    opacity: 0;
    animation: fadeSlideUp .5s ease forwards;
  }

  /* â”€â”€ Mobile Responsive â”€â”€ */
  @media (max-width: 768px) {
    .container { padding: 1.5rem 1rem; }
    .header { padding: 1rem 1.25rem; }
    .upload-zone { padding: 2rem 1.25rem; }
    .metric-grid { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 480px) {
    .header h1 { font-size: 1.1rem; }
    .metric-grid { grid-template-columns: 1fr; }
    .preview-item { width: 90px; height: 90px; }
    .score-dashboard { padding: 1rem; gap: 1rem; }
    .improve-head { flex-direction: column; align-items: flex-start; gap: .3rem; }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1><span>ìƒí˜</span>ê¸°íšê¸°</h1>
  <span class="badge">ì „í™˜ìœ¨ ë¶„ì„ ì—”ì§„ v2.0</span>
</div>

<div class="container">

  <!-- Upload Zone -->
  <div class="upload-zone" id="uploadZone">
    <div class="icon">ğŸ“„</div>
    <p><strong>ìƒì„¸í˜ì´ì§€ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</strong></p>
    <p class="hint">JPG, PNG, WEBP ì§€ì› Â· ë³µìˆ˜ ì´ë¯¸ì§€ ê°€ëŠ¥ Â· ìœ„â†’ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.webp" multiple>
  </div>
  <div class="preview-grid" id="previewGrid"></div>

  <!-- Analyze Button -->
  <button class="btn-analyze" id="btnAnalyze" disabled>ë¶„ì„ ì‹œì‘</button>

  <!-- Multi-step Loading -->
  <div class="loading-wrap" id="loadingWrap">
    <div class="spinner"></div>
    <div class="loading-steps">
      <div class="loading-step" id="step1"><span class="step-icon">â—‹</span> ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
      <div class="loading-step" id="step2"><span class="step-icon">â—‹</span> í…ìŠ¤íŠ¸ ë¶„ì„</div>
      <div class="loading-step" id="step3"><span class="step-icon">â—‹</span> êµ¬ì¡° ë¶„ì„</div>
      <div class="loading-step" id="step4"><span class="step-icon">â—‹</span> ê°œì„ ì•ˆ ìƒì„±</div>
    </div>
    <p class="loading-msg" id="loadingMsg">Claudeê°€ ìƒì„¸í˜ì´ì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤â€¦</p>
  </div>

  <!-- Error -->
  <div class="error-box" id="errorBox"></div>

  <!-- Results -->
  <div id="results">

    <!-- Score Dashboard -->
    <div class="section-title">ì¢…í•© ì ìˆ˜</div>
    <div class="score-dashboard anim-card" id="scoreDashboard">
      <div class="score-gauge" id="scoreGauge"></div>
      <div class="score-bars" id="scoreBars"></div>
    </div>

    <!-- Basic Info -->
    <div class="section-title">ê¸°ë³¸ ì •ë³´</div>
    <div class="metric-grid" id="metricGrid"></div>

    <!-- Key Copy -->
    <div class="section-title">í•µì‹¬ ì¹´í”¼</div>
    <div id="keyCopyWrap"></div>

    <!-- Framework Analysis -->
    <div class="section-title">ì„¤ë“ í”„ë ˆì„ì›Œí¬ ë¶„ì„</div>
    <div class="framework-grid" id="frameworkGrid"></div>

    <!-- Sections -->
    <div class="section-title">ì„¹ì…˜ë³„ ì„¤ë“ êµ¬ì¡°</div>
    <div id="sectionsWrap"></div>

    <!-- Structure Summary -->
    <div class="section-title">ì „ì²´ êµ¬ì¡° ìš”ì•½</div>
    <div class="summary-box" id="summaryBox"></div>

    <!-- Strengths / Weaknesses -->
    <div class="section-title">ê°•ì  / ì•½ì </div>
    <div class="sw-grid" id="swGrid"></div>

    <!-- Improvements -->
    <div class="section-title">ì „í™˜ìœ¨ ê°œì„  í¬ì¸íŠ¸</div>
    <div id="improveWrap"></div>

    <!-- Recommended Structure -->
    <div class="section-title">ê¶Œì¥ ìƒì„¸í˜ì´ì§€ êµ¬ì¡°</div>
    <div class="timeline" id="timelineWrap"></div>

    <!-- Draft Generation -->
    <div class="section-title">í”¼ê·¸ë§ˆìš© ì´ˆì•ˆ</div>
    <div class="draft-section" id="draftSection">
      <button class="btn-draft" id="btnDraft">ì´ˆì•ˆ ìƒì„± (SVG ì™€ì´ì–´í”„ë ˆì„)</button>
      <div class="draft-preview" id="draftPreview"></div>
      <div class="draft-actions" id="draftActions" style="display:none">
        <a class="btn-download-svg" id="btnDownloadSvg" download="wireframe.svg">SVG ë‹¤ìš´ë¡œë“œ (Figmaìš©)</a>
      </div>
      <div class="draft-guide" id="draftGuide" style="display:none">
        Figmaì—ì„œ ì‚¬ìš©í•˜ê¸°: File > Place Imageë¡œ ë‹¤ìš´ë¡œë“œí•œ SVGë¥¼ ê°€ì ¸ì˜¤ë©´ í¸ì§‘ ê°€ëŠ¥í•œ ë ˆì´ì–´ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.
        ê° ì„¹ì…˜ë³„ ìƒ‰ìƒ ì½”ë“œê°€ ì ìš©ë˜ì–´ ìˆì–´ ì—­í• ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>

    <!-- Figma Export -->
    <div class="section-title">í”¼ê·¸ë§ˆë¡œ ë‚´ë³´ë‚´ê¸°</div>
    <div class="figma-section" id="figmaSection">
      <button class="btn-figma" id="btnFigmaExport" disabled>
        <svg width="16" height="16" viewBox="0 0 38 57" fill="none"><path d="M19 28.5a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z" fill="#1ABCFE"/><path d="M0 47.5A9.5 9.5 0 0 1 9.5 38H19v9.5a9.5 9.5 0 1 1-19 0z" fill="#0ACF83"/><path d="M19 0v19h9.5a9.5 9.5 0 1 0 0-19H19z" fill="#FF7262"/><path d="M0 9.5A9.5 9.5 0 0 0 9.5 19H19V0H9.5A9.5 9.5 0 0 0 0 9.5z" fill="#F24E1E"/><path d="M0 28.5A9.5 9.5 0 0 0 9.5 38H19V19H9.5A9.5 9.5 0 0 0 0 28.5z" fill="#A259FF"/></svg>
        ì›ë³¸ í˜ì´ì§€ Figmaë¡œ ë³€í™˜
      </button>
      <div class="figma-progress" id="figmaProgress">
        <div class="figma-progress-bar"><div class="figma-progress-fill" id="figmaProgressFill"></div></div>
        <div class="figma-progress-text" id="figmaProgressText">ì¤€ë¹„ ì¤‘â€¦</div>
      </div>
      <div class="figma-results" id="figmaResults"></div>
      <div class="figma-guide" id="figmaGuide" style="display:none">
        <strong>Figmaì—ì„œ ë””ìì¸ ì—´ê¸°:</strong>
        <ol>
          <li>Figmaì—ì„œ <strong>Codia AI Design</strong> í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•˜ì„¸ìš”</li>
          <li>ë‹¤ìš´ë¡œë“œí•œ JSON íŒŒì¼ì„ í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ ì„í¬íŠ¸í•˜ì„¸ìš”</li>
          <li>í¸ì§‘ ê°€ëŠ¥í•œ ë ˆì´ì–´ë¡œ ë³€í™˜ëœ ë””ìì¸ì„ í™•ì¸í•˜ì„¸ìš”</li>
        </ol>
      </div>
    </div>

    <!-- JSON Download -->
    <a class="btn-download" id="btnDownload" download="analysis_result.json" style="margin-top:1.5rem">JSON ì›ë³¸ ë‹¤ìš´ë¡œë“œ</a>
  </div>

</div>

<script>
const ROLE_COLORS = {
  'ê°ì •ê³µê°': '#ff6b6b',
  'ë¬¸ì œì œê¸°': '#ffa94d',
  'í•´ê²°ì œì‹œ': '#51cf66',
  'ì°¨ë³„í™”': '#339af0',
  'ì¦ê±°': '#845ef7',
  'ì‹ ë¢°': '#20c997',
  'CTA': '#f06595'
};

const SCORE_COLORS = {
  visual: '#845ef7',
  copy: '#339af0',
  structure: '#51cf66',
  trust: '#20c997',
  mobile: '#ffa94d',
  conversion: '#f06595'
};

const SCORE_LABELS = {
  visual: 'ì‹œê°',
  copy: 'ì¹´í”¼',
  structure: 'êµ¬ì¡°',
  trust: 'ì‹ ë¢°',
  mobile: 'ëª¨ë°”ì¼',
  conversion: 'ì „í™˜'
};

const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const previewGrid = document.getElementById('previewGrid');
const btnAnalyze = document.getElementById('btnAnalyze');
const loadingWrap = document.getElementById('loadingWrap');
const errorBox = document.getElementById('errorBox');
const results = document.getElementById('results');

let selectedFiles = [];
let lastAnalysisData = null;
const btnFigmaExport = document.getElementById('btnFigmaExport');

// â”€â”€ Upload handling â”€â”€
uploadZone.addEventListener('click', () => fileInput.click());
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  addFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', () => addFiles(fileInput.files));

function addFiles(fileList) {
  for (const f of fileList) {
    if (/\.(jpe?g|png|webp)$/i.test(f.name)) selectedFiles.push(f);
  }
  renderPreviews();
}

function renderPreviews() {
  previewGrid.innerHTML = '';
  selectedFiles.forEach((f, i) => {
    const div = document.createElement('div');
    div.className = 'preview-item';
    const img = document.createElement('img');
    img.src = URL.createObjectURL(f);
    const btn = document.createElement('button');
    btn.className = 'remove';
    btn.textContent = '\u2715';
    btn.onclick = () => { selectedFiles.splice(i, 1); renderPreviews(); };
    div.append(img, btn);
    previewGrid.appendChild(div);
  });
  btnAnalyze.disabled = selectedFiles.length === 0;
  btnFigmaExport.disabled = selectedFiles.length === 0;
}

// â”€â”€ Client-side image resize â”€â”€
const RESIZE_WIDTH = 1400;
const JPEG_QUALITY = 0.92;

function resizeImage(file) {
  return new Promise((resolve) => {
    const img = new window.Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      if (w > RESIZE_WIDTH) {
        h = Math.round(h * RESIZE_WIDTH / w);
        w = RESIZE_WIDTH;
      }
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => resolve(blob), 'image/jpeg', JPEG_QUALITY);
      URL.revokeObjectURL(img.src);
    };
    img.src = URL.createObjectURL(file);
  });
}

// â”€â”€ Loading Steps â”€â”€
function setLoadingStep(step) {
  const msgs = [
    'ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤â€¦',
    'Claudeê°€ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤â€¦',
    'ì„¤ë“ êµ¬ì¡°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤â€¦',
    'ê°œì„ ì•ˆì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤â€¦'
  ];
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('step' + i);
    el.classList.remove('active', 'done');
    if (i < step) {
      el.classList.add('done');
      el.querySelector('.step-icon').textContent = '\u2713';
    } else if (i === step) {
      el.classList.add('active');
      el.querySelector('.step-icon').textContent = '\u25CF';
    } else {
      el.querySelector('.step-icon').textContent = '\u25CB';
    }
  }
  document.getElementById('loadingMsg').textContent = msgs[step - 1] || '';
}

// â”€â”€ Analyze â”€â”€
btnAnalyze.addEventListener('click', async () => {
  if (selectedFiles.length === 0) return;

  errorBox.classList.remove('show');
  results.classList.remove('show');
  loadingWrap.classList.add('show');
  btnAnalyze.disabled = true;
  setLoadingStep(1);

  const formData = new FormData();
  for (let i = 0; i < selectedFiles.length; i++) {
    const blob = await resizeImage(selectedFiles[i]);
    formData.append('images', blob, selectedFiles[i].name.replace(/\.\w+$/, '.jpg'));
  }

  setLoadingStep(2);

  // Simulate step progression during API call
  const stepTimer2 = setTimeout(() => setLoadingStep(3), 15000);
  const stepTimer3 = setTimeout(() => setLoadingStep(4), 35000);

  try {
    const resp = await fetch('/analyze', { method: 'POST', body: formData });
    clearTimeout(stepTimer2);
    clearTimeout(stepTimer3);
    setLoadingStep(4);

    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');

    lastAnalysisData = data;
    renderResults(data);

    // Smooth scroll to results
    setTimeout(() => {
      document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 200);
  } catch (err) {
    errorBox.textContent = err.message;
    errorBox.classList.add('show');
  } finally {
    loadingWrap.classList.remove('show');
    btnAnalyze.disabled = false;
  }
});

// â”€â”€ Score Gauge SVG â”€â”€
function createGaugeSVG(score, grade) {
  const pct = Math.min(score, 100) / 100;
  const r = 54;
  const circ = 2 * Math.PI * r;
  const dashLen = circ * 0.75; // 270 degree arc
  const filled = dashLen * pct;
  let color = '#51cf66';
  if (score < 40) color = '#ff6b6b';
  else if (score < 60) color = '#ffa94d';
  else if (score < 80) color = '#339af0';

  return `
    <svg viewBox="0 0 130 130">
      <circle cx="65" cy="65" r="${r}" fill="none" stroke="var(--surface2)" stroke-width="10"
              stroke-dasharray="${dashLen} ${circ}" stroke-dashoffset="0"
              transform="rotate(135 65 65)" stroke-linecap="round"/>
      <circle cx="65" cy="65" r="${r}" fill="none" stroke="${color}" stroke-width="10"
              stroke-dasharray="${filled} ${circ}" stroke-dashoffset="0"
              transform="rotate(135 65 65)" stroke-linecap="round"
              class="gauge-fill"/>
      <text x="65" y="62" text-anchor="middle" fill="var(--text)"
            font-size="28" font-weight="800" font-family="Pretendard,sans-serif">${score}</text>
      <text x="65" y="80" text-anchor="middle" fill="var(--text-dim)"
            font-size="11" font-family="Pretendard,sans-serif">/ 100</text>
    </svg>
  `;
}

// â”€â”€ Render Results â”€â”€
function renderResults(data) {
  // Animation delay counter
  let delay = 0;

  // Score Dashboard
  const scores = data.scores || {};
  const overallScore = data.overall_score || 0;
  const grade = data.grade || '-';

  const gaugeEl = document.getElementById('scoreGauge');
  gaugeEl.innerHTML = createGaugeSVG(overallScore, grade) +
    `<div class="grade-label">${grade}</div>`;

  const barsEl = document.getElementById('scoreBars');
  barsEl.innerHTML = Object.entries(SCORE_LABELS).map(([key, label]) => {
    const val = scores[key] || 0;
    const color = SCORE_COLORS[key];
    return `
      <div class="score-bar-item">
        <div class="score-bar-label">${label}</div>
        <div class="score-bar-track">
          <div class="score-bar-fill" data-width="${val}" style="background:${color}"></div>
        </div>
        <div class="score-bar-value" style="color:${color}">${val}</div>
      </div>
    `;
  }).join('');

  // Animate score bars
  setTimeout(() => {
    document.querySelectorAll('.score-bar-fill').forEach(bar => {
      bar.style.width = bar.dataset.width + '%';
    });
  }, 300);

  // Metrics
  const metricGrid = document.getElementById('metricGrid');
  metricGrid.innerHTML = [
    { label: 'ìƒí’ˆëª…', value: data.product_name },
    { label: 'ë¸Œëœë“œ', value: data.brand_name },
    { label: 'ì¹´í…Œê³ ë¦¬', value: data.category },
    { label: 'íƒ€ê²Ÿ ê³ ê°', value: data.estimated_target },
    { label: 'ê°€ê²©ëŒ€', value: data.price_range },
  ].map((m, i) => `<div class="metric-card anim-card" style="animation-delay:${i*0.05}s">
    <div class="label">${m.label}</div><div class="value">${m.value || '-'}</div>
  </div>`).join('');

  // Key Copy
  const keyCopyWrap = document.getElementById('keyCopyWrap');
  const copies = data.key_copy_text || [];
  keyCopyWrap.innerHTML = copies.length
    ? copies.map(c => `<div class="summary-box" style="margin-bottom:.5rem;font-style:italic">"${escapeHtml(c)}"</div>`).join('')
    : '<div class="summary-box">-</div>';

  // Framework Analysis
  const fwGrid = document.getElementById('frameworkGrid');
  const fw = data.framework_analysis;
  if (fw) {
    let aidmaHtml = '';
    if (fw.aidma) {
      const stages = {Attention:'ì£¼ì˜', Interest:'ê´€ì‹¬', Desire:'ìš•êµ¬', Memory:'ê¸°ì–µ', Action:'í–‰ë™'};
      aidmaHtml = `<div class="framework-card anim-card">
        <h4>AIDMA ë¶„ì„</h4>
        ${Object.entries(stages).map(([k,v]) => `
          <div class="framework-item">
            <div class="fw-stage">${v}</div>
            <div>${escapeHtml(fw.aidma[k.toLowerCase()] || '-')}</div>
          </div>
        `).join('')}
      </div>`;
    }
    let pasonaHtml = '';
    if (fw.pasona) {
      const stages = {Problem:'ë¬¸ì œ', Affinity:'ê³µê°', Solution:'í•´ê²°', Offer:'ì œì•ˆ', Narrowing:'í•œì •', Action:'í–‰ë™'};
      pasonaHtml = `<div class="framework-card anim-card">
        <h4>PASONA ë¶„ì„</h4>
        ${Object.entries(stages).map(([k,v]) => `
          <div class="framework-item">
            <div class="fw-stage">${v}</div>
            <div>${escapeHtml(fw.pasona[k.toLowerCase()] || '-')}</div>
          </div>
        `).join('')}
      </div>`;
    }
    fwGrid.innerHTML = aidmaHtml + pasonaHtml;
  } else {
    fwGrid.innerHTML = '';
  }

  // Sections
  const sectionsWrap = document.getElementById('sectionsWrap');
  sectionsWrap.innerHTML = (data.sections || []).map((sec, i) => {
    const color = ROLE_COLORS[sec.role] || '#868e96';
    const aidmaTag = sec.aidma_stage ? `<span class="stage-tag">${escapeHtml(sec.aidma_stage)}</span>` : '';
    const pasonaTag = sec.pasona_stage ? `<span class="stage-tag" style="background:rgba(81,207,102,.12);color:var(--green)">${escapeHtml(sec.pasona_stage)}</span>` : '';
    const scoreBadge = sec.section_score != null ? `<span class="score-badge">${sec.section_score}ì </span>` : '';
    const impTip = sec.improvement_suggestion ? `<div class="improvement-tip">${escapeHtml(sec.improvement_suggestion)}</div>` : '';
    return `<div class="section-card anim-card" style="border-left:4px solid ${color};animation-delay:${i*0.08}s">
      <div class="card-head">
        <div class="order-badge" style="background:${color}">${sec.order}</div>
        <div class="role-name" style="color:${color}">${escapeHtml(sec.role)}</div>
        ${aidmaTag}${pasonaTag}${scoreBadge}
      </div>
      <div class="detail"><strong>ì‹œê° êµ¬ì„±:</strong> ${escapeHtml(sec.image_description || '-')}</div>
      <div class="detail"><strong>ì¹´í”¼ ìš”ì•½:</strong> ${escapeHtml(sec.copy_summary || '-')}</div>
      <div class="detail"><strong>ì„¤ë“ ì˜ë„:</strong> ${escapeHtml(sec.persuasion_intent || '-')}</div>
      <div class="detail"><strong>ì‹¬ë¦¬ ê¸°ë²•:</strong> ${escapeHtml(sec.psychology_used || '-')}</div>
      ${impTip}
    </div>`;
  }).join('');

  // Summary
  document.getElementById('summaryBox').textContent = data.overall_structure || '-';

  // Strengths / Weaknesses
  const swGrid = document.getElementById('swGrid');
  const strengths = data.strengths || [];
  const weaknesses = data.weaknesses || [];

  function renderSwItems(items, isStrength) {
    if (!items.length) return '<p style="color:var(--text-dim);font-size:.85rem">-</p>';
    return items.map((item, i) => {
      if (typeof item === 'string') {
        return `<div class="sw-item"><div class="sw-title">${isStrength ? '\u2705' : '\u26A0\uFE0F'} ${escapeHtml(item)}</div></div>`;
      }
      return `<div class="sw-item" onclick="this.classList.toggle('open')">
        <div class="sw-title">
          ${isStrength ? '\u2705' : '\u26A0\uFE0F'} ${escapeHtml(item.title || '')}
          <span class="sw-toggle">\u25BC</span>
        </div>
        <div class="sw-detail">${escapeHtml(item.detail || '')}</div>
        <div class="sw-impact">${escapeHtml(item.impact || '')}</div>
      </div>`;
    }).join('');
  }

  swGrid.innerHTML = `
    <div class="sw-box"><h4>ê°•ì </h4>${renderSwItems(strengths, true)}</div>
    <div class="sw-box"><h4>ì•½ì </h4>${renderSwItems(weaknesses, false)}</div>
  `;

  // Improvements
  const improveWrap = document.getElementById('improveWrap');
  const improvements = data.conversion_improvement_points || [];
  improveWrap.innerHTML = improvements.map((item, i) => {
    if (typeof item === 'string') {
      return `<div class="improve-card anim-card" style="animation-delay:${i*0.06}s">
        <div class="improve-title">${escapeHtml(item)}</div>
      </div>`;
    }
    const p = (item.priority || '').replace(/^\s+/, '');
    let pClass = 'low', pLabel = 'í•˜';
    if (p === 'ìƒ') { pClass = 'high'; pLabel = 'ìƒ'; }
    else if (p === 'ì¤‘') { pClass = 'mid'; pLabel = 'ì¤‘'; }
    else { pLabel = p || 'í•˜'; }

    return `<div class="improve-card priority-${pClass} anim-card" style="animation-delay:${i*0.06}s">
      <div class="improve-head">
        <span class="priority-badge ${pClass}">${escapeHtml(pLabel)}</span>
        <span class="category-badge">${escapeHtml(item.category || '')}</span>
        <span class="improve-title">${escapeHtml(item.title || '')}</span>
      </div>
      ${item.current_state ? `<div class="improve-body"><span class="label">í˜„ì¬:</span> ${escapeHtml(item.current_state)}</div>` : ''}
      ${item.problem ? `<div class="improve-body"><span class="label">ë¬¸ì œ:</span> ${escapeHtml(item.problem)}</div>` : ''}
      ${item.suggestion ? `<div class="improve-body"><span class="label">ì œì•ˆ:</span> ${escapeHtml(item.suggestion)}</div>` : ''}
      ${item.expected_effect ? `<div class="improve-effect">${escapeHtml(item.expected_effect)}</div>` : ''}
    </div>`;
  }).join('');

  // Recommended Structure Timeline
  const timelineWrap = document.getElementById('timelineWrap');
  const recStruct = data.recommended_structure || [];
  if (recStruct.length > 0) {
    timelineWrap.innerHTML = recStruct.map((item, i) => {
      const roleColor = ROLE_COLORS[item.role] || '#868e96';
      return `<div class="timeline-item anim-card" style="animation-delay:${i*0.08}s">
        <div class="timeline-card">
          <div class="tl-head">
            <span class="tl-order">#${item.order || i+1}</span>
            <span class="tl-name">${escapeHtml(item.section_name || '')}</span>
            <span class="tl-role-tag" style="background:${roleColor}">${escapeHtml(item.role || '')}</span>
            ${item.aidma_stage ? `<span class="stage-tag">${escapeHtml(item.aidma_stage)}</span>` : ''}
          </div>
          ${item.key_elements ? `<div class="tl-body">${item.key_elements.map(e => escapeHtml(e)).join(' Â· ')}</div>` : ''}
          ${item.suggested_copy ? `<div class="tl-copy">"${escapeHtml(item.suggested_copy)}"</div>` : ''}
          ${item.design_direction ? `<div class="tl-body" style="margin-top:.25rem;font-size:.78rem;color:var(--text-dim)">${escapeHtml(item.design_direction)}</div>` : ''}
        </div>
      </div>`;
    }).join('');
  } else {
    timelineWrap.innerHTML = '<p style="color:var(--text-dim);font-size:.85rem">ê¶Œì¥ êµ¬ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
  }

  // Reset draft section
  document.getElementById('draftPreview').classList.remove('show');
  document.getElementById('draftPreview').innerHTML = '';
  document.getElementById('draftActions').style.display = 'none';
  document.getElementById('draftGuide').style.display = 'none';

  // Download JSON
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  document.getElementById('btnDownload').href = URL.createObjectURL(blob);

  results.classList.add('show');
}

// â”€â”€ Draft Generation â”€â”€
document.getElementById('btnDraft').addEventListener('click', async () => {
  if (!lastAnalysisData || !lastAnalysisData.recommended_structure) {
    alert('ë¶„ì„ ê²°ê³¼ì— ê¶Œì¥ êµ¬ì¡°(recommended_structure) ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  const btn = document.getElementById('btnDraft');
  btn.disabled = true;
  btn.textContent = 'ìƒì„± ì¤‘â€¦';

  try {
    const resp = await fetch('/generate-draft', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        recommended_structure: lastAnalysisData.recommended_structure,
        product_name: lastAnalysisData.product_name || ''
      })
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || 'ì´ˆì•ˆ ìƒì„± ì‹¤íŒ¨');

    const preview = document.getElementById('draftPreview');
    preview.innerHTML = data.svg;
    preview.classList.add('show');

    // Download link
    const svgBlob = new Blob([data.svg], { type: 'image/svg+xml' });
    document.getElementById('btnDownloadSvg').href = URL.createObjectURL(svgBlob);
    document.getElementById('draftActions').style.display = 'flex';
    document.getElementById('draftGuide').style.display = 'block';

    preview.scrollIntoView({ behavior: 'smooth', block: 'center' });
  } catch (err) {
    alert('ì´ˆì•ˆ ìƒì„± ì˜¤ë¥˜: ' + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ì´ˆì•ˆ ìƒì„± (SVG ì™€ì´ì–´í”„ë ˆì„)';
  }
});

// â”€â”€ Figma Export â”€â”€
btnFigmaExport.addEventListener('click', async () => {
  if (selectedFiles.length === 0) return;

  const progressWrap = document.getElementById('figmaProgress');
  const progressFill = document.getElementById('figmaProgressFill');
  const progressText = document.getElementById('figmaProgressText');
  const resultsWrap = document.getElementById('figmaResults');
  const guide = document.getElementById('figmaGuide');

  btnFigmaExport.disabled = true;
  progressWrap.classList.add('show');
  resultsWrap.classList.remove('show');
  resultsWrap.innerHTML = '';
  guide.style.display = 'none';
  progressFill.style.width = '0%';
  progressText.textContent = `ì´ë¯¸ì§€ ${selectedFiles.length}ì¥ì„ Codia APIë¡œ ë³€í™˜ ì¤‘â€¦`;

  const formData = new FormData();
  for (let i = 0; i < selectedFiles.length; i++) {
    const blob = await resizeImage(selectedFiles[i]);
    formData.append('images', blob, selectedFiles[i].name.replace(/\.\w+$/, '.jpg'));
    progressFill.style.width = Math.round(((i + 1) / selectedFiles.length) * 30) + '%';
  }

  progressFill.style.width = '30%';
  progressText.textContent = 'Codia API ì‘ë‹µ ëŒ€ê¸° ì¤‘â€¦ (ìµœëŒ€ 2ë¶„ ì†Œìš”)';

  try {
    const resp = await fetch('/export-figma', { method: 'POST', body: formData });
    progressFill.style.width = '90%';
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || 'Figma ë³€í™˜ ì‹¤íŒ¨');

    progressFill.style.width = '100%';
    progressText.textContent = 'ë³€í™˜ ì™„ë£Œ!';

    const results = data.results || [];
    resultsWrap.innerHTML = results.map((r, i) => {
      if (r.status === 'ok') {
        const jsonStr = JSON.stringify(r.data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        return `<div class="figma-result-item">
          <span class="figma-result-label">ì´ë¯¸ì§€ ${i + 1} â€” ë³€í™˜ ì„±ê³µ</span>
          <a class="btn-figma-download" href="${url}" download="figma_design_${i + 1}.json">JSON ë‹¤ìš´ë¡œë“œ</a>
        </div>`;
      } else {
        return `<div class="figma-result-item error">
          <span class="figma-result-label" style="color:var(--red)">ì´ë¯¸ì§€ ${i + 1} â€” ì˜¤ë¥˜: ${escapeHtml(r.error)}</span>
        </div>`;
      }
    }).join('');

    resultsWrap.classList.add('show');
    if (results.some(r => r.status === 'ok')) {
      guide.style.display = 'block';
    }

    resultsWrap.scrollIntoView({ behavior: 'smooth', block: 'center' });
  } catch (err) {
    progressText.textContent = 'ì˜¤ë¥˜: ' + err.message;
    progressFill.style.width = '100%';
    progressFill.style.background = 'var(--red)';
  } finally {
    btnFigmaExport.disabled = false;
    setTimeout(() => {
      progressFill.style.background = '#a259ff';
    }, 3000);
  }
});

// â”€â”€ Utility â”€â”€
function escapeHtml(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}
</script>
</body>
</html>
